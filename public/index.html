<html>
    <head>
        <style>
            body {
                font-family: 'Courier New', Courier, monospace
            }

            #image {
                font-family: 'Courier New', Courier, monospace;
                font-size: 1.4ex;
                padding: 0;
                background: #000;
                color: #fff;
                overflow: hidden;
                resize: both;
                letter-spacing: 0;
                height: auto;
            }

            i {
                font-style: normal
            }
        </style>
    </head>
    
    <body>
        <div  id="image">
        </div>

        <form id="uploadImage" action="/ascii:image" method="POST" enctype="multipart/form-data">
            <input type="file" id="uploadImageField" name="image">
            <br>
            <label for="color">Color?</label>   <input type="checkbox" name="color" id="color">
            <br>
            <label for="rev">Reverse?</label>   <input type="checkbox" name="reverse" id="reverse">
            <input type="submit" name="submit">
        </form>
    </body>

    <script>

        window.onload = () => {
            const imageElement = document.querySelector("#image")
            const imageAjax = new XMLHttpRequest()
            const form = document.querySelector("#uploadImage")

            form.onsubmit = (e) => {
                e.preventDefault()
                const color = document.querySelector("#color").checked;
                const reverse = document.querySelector("#reverse").checked;
                var formData = new FormData()
                formData.append("image", document.querySelector("[type=file]").files[0])
                formData.append("color", color)
                formData.append("reverse", reverse)

                var parsedImage = {}

                imageAjax.open("POST", "/ascii:image", true)
                imageAjax.send(formData)
                
                imageAjax.onreadystatechange = () => {

                    if(imageAjax.readyState === 4) {
                        parsedImage = JSON.parse(imageAjax.responseText)
                        const image = parsedImage.image;
                        

                        const ratio = parsedImage.aspect;
                        const width = parsedImage.width;
                        const height = width / ratio;

                        console.log(width, height, ratio);
                        
                        imageElement.style.width = (width * 1.43) + "ex";
                        imageElement.style.height = "auto";

                        imageElement.style.background = (reverse) ? "#fff" : "#000";
                        imageElement.style.color = (reverse) ? "#000" : "#fff";

                        if(!color) {
                            imageElement.textContent = image;
                        } else if(color) {
                            var imageHTMLWithColor = "";
                            for(var i = 0; i < image.length; i++) { // for each letter (pixel)
                                if(image.charAt(i) == "\n") {
                                    imageHTMLWithColor += "\n"
                                    continue;
                                }
                                console.log("here");
                                if(!parsedImage.alpha) {
                                    imageHTMLWithColor += `<i style="color: rgb(${parsedImage.pixel_values[i][0]}, ${parsedImage.pixel_values[i][1]}, ${parsedImage.pixel_values[i][2]})">${image.charAt(i)}</i>`
                                } else {
                                    imageHTMLWithColor += `<i style="color: rgba(${parsedImage.pixel_values[i][0]}, ${parsedImage.pixel_values[i][1]}, ${parsedImage.pixel_values[i][2]}, ${parsedImage.pixel_values[i][3]})">${image.charAt(i)}</i>`
                                }
                            }

                            imageElement.innerHTML = imageHTMLWithColor;
                        }
                    }
                }
            }
        }
    </script>
    
</html>